<style>
@font-face {
  font-family: 'weathericons';
  src: url('https://cdn.jsdelivr.net/gh/erikflowers/weather-icons@2.0.10/font/weathericons-regular-webfont.woff2') format('woff2');
  font-weight: normal;
  font-style: normal;
}
.wi {
  font-family: 'weathericons';
  font-style: normal;
  font-weight: normal;
  font-variant: normal;
  text-transform: none;
  line-height: 1;
  -webkit-font-smoothing: antialiased;
}
.wi::before { display: inline-block; }
.wi-day-sunny:before { content: "\f00d"; }
.wi-day-sunny-overcast:before { content: "\f00c"; }
.wi-day-cloudy:before { content: "\f002"; }
.wi-night-clear:before { content: "\f02e"; }
.wi-night-partly-cloudy:before { content: "\f083"; }
.wi-night-cloudy:before { content: "\f031"; }
.wi-wmo4680-3:before { content: "\f013"; }
.wi-wmo4680-45:before { content: "\f015"; }
.wi-wmo4680-48:before { content: "\f01b"; }
.wi-wmo4680-51:before { content: "\f01c"; }
.wi-wmo4680-52:before { content: "\f019"; }
.wi-wmo4680-53:before { content: "\f019"; }
.wi-wmo4680-54:before { content: "\f076"; }
.wi-wmo4680-55:before { content: "\f076"; }
.wi-wmo4680-56:before { content: "\f076"; }
.wi-wmo4680-57:before { content: "\f01c"; }
.wi-wmo4680-61:before { content: "\f01c"; }
.wi-wmo4680-62:before { content: "\f019"; }
.wi-wmo4680-63:before { content: "\f019"; }
.wi-wmo4680-64:before { content: "\f015"; }
.wi-wmo4680-65:before { content: "\f015"; }
.wi-wmo4680-66:before { content: "\f015"; }
.wi-wmo4680-67:before { content: "\f017"; }
.wi-wmo4680-71:before { content: "\f01b"; }
.wi-wmo4680-72:before { content: "\f01b"; }
.wi-wmo4680-73:before { content: "\f01b"; }
.wi-wmo4680-74:before { content: "\f076"; }
.wi-wmo4680-75:before { content: "\f076"; }
.wi-wmo4680-76:before { content: "\f076"; }
.wi-wmo4680-77:before { content: "\f01b"; }
.wi-wmo4680-80:before { content: "\f019"; }
.wi-wmo4680-81:before { content: "\f01c"; }
.wi-wmo4680-82:before { content: "\f019"; }
.wi-wmo4680-85:before { content: "\f017"; }
.wi-wmo4680-86:before { content: "\f017"; }
.wi-wmo4680-95:before { content: "\f01e"; }
.wi-wmo4680-96:before { content: "\f01e"; }
.wi-wmo4680-99:before { content: "\f056"; }
.wi-na:before { content: "\f07b"; }
.wi-raindrop:before { content: "\f078"; }
.wi-sunrise:before { content: "\f051"; }
.wi-sunset:before { content: "\f052"; }
</style>

{% comment %}
  weather_current: Current conditions for two-column layout
  Params: current
{% endcomment %}
{% template weather_current %}
<div style="display:flex; flex-direction:row; align-items:center; justify-content:center; gap:12px; width:100%; padding:8px 0 4px 0;">
  <i class="wi {{ current.icon_class }}" style="font-size:110px; line-height:1; flex-shrink:0;"></i>
  <div class="value--xxlarge" data-pixel-perfect="true" style="line-height:1; white-space:nowrap; flex-shrink:0;">{{ current.temperature }}&deg;</div>
  <div style="display:flex; flex-direction:column; gap:2px; min-width:0;">
    <div class="value--xxsmall" data-pixel-perfect="true" style="white-space:nowrap;">{{ current.condition }}</div>
    <div class="value--xxsmall" data-pixel-perfect="true" style="white-space:nowrap;">Feels {{ current.apparent_temperature }}&deg;</div>
    <div class="value--xxsmall" data-pixel-perfect="true" style="white-space:nowrap;">Humidity {{ current.relative_humidity }}%</div>
    <div class="value--xxsmall" data-pixel-perfect="true" style="white-space:nowrap;">Wind {{ current.wind_speed }} {{ current.wind_direction }}</div>
  </div>
</div>
{% endtemplate %}

{% comment %}
  weather_current_compact: Compact current conditions for smaller layouts
  Params: current, icon_size (default 64), show_extra (default true — shows humidity + wind)
{% endcomment %}
{% template weather_current_compact %}
<div style="display:flex; flex-direction:row; align-items:center; justify-content:center; gap:10px; width:100%; padding:6px 0 4px 0;">
  <i class="wi {{ current.icon_class }}" style="font-size:{{ icon_size | default: 64 }}px; line-height:1; flex-shrink:0;"></i>
  <div class="value--xlarge" data-pixel-perfect="true" style="line-height:1; white-space:nowrap; flex-shrink:0;">{{ current.temperature }}&deg;</div>
  <div style="display:flex; flex-direction:column; gap:2px; min-width:0;">
    <div class="value--xxsmall" data-pixel-perfect="true" style="white-space:nowrap;">{{ current.condition }}</div>
    <div class="value--xxsmall" data-pixel-perfect="true" style="white-space:nowrap;">Feels {{ current.apparent_temperature }}&deg;</div>
    {% if show_extra != false %}
    <div class="value--xxsmall" data-pixel-perfect="true" style="white-space:nowrap;">Humidity {{ current.relative_humidity }}%</div>
    <div class="value--xxsmall" data-pixel-perfect="true" style="white-space:nowrap;">Wind {{ current.wind_speed }} {{ current.wind_direction }}</div>
    {% endif %}
  </div>
</div>
{% endtemplate %}

{% comment %}
  weather_hourly_chart: Highcharts spline for next 24 hours
  Params: hourly, daily, current_time, chart_height
{% endcomment %}
{% template weather_hourly_chart %}
<script src="https://trmnl.com/js/highcharts/12.3.0/highcharts.js"></script>
<script src="https://trmnl.com/js/highcharts/12.3.0/pattern-fill.js"></script>
{% assign hour_labels = "" %}
{% assign temp_data = "" %}
{% assign precip_data = "" %}
{% assign icon_classes = "" %}
{% assign hour_times = "" %}
{% for entry in hourly.entries %}
  {% if forloop.first %}
    {% assign hour_labels = entry.label | prepend: '"' | append: '"' %}
    {% assign temp_data = entry.temperature | append: "" %}
    {% assign precip_data = entry.precipitation_probability | append: "" %}
    {% assign icon_classes = entry.icon_class | prepend: '"' | append: '"' %}
    {% assign hour_times = entry.time | prepend: '"' | append: '"' %}
  {% else %}
    {% assign hour_labels = hour_labels | append: ',"' | append: entry.label | append: '"' %}
    {% assign temp_data = temp_data | append: "," | append: entry.temperature %}
    {% assign precip_data = precip_data | append: "," | append: entry.precipitation_probability %}
    {% assign icon_classes = icon_classes | append: ',"' | append: entry.icon_class | append: '"' %}
    {% assign hour_times = hour_times | append: ',"' | append: entry.time | append: '"' %}
  {% endif %}
{% endfor %}
<div style="flex:1; display:flex; flex-direction:column; justify-content:flex-end;">
  <div class="label" data-pixel-perfect="true" style="letter-spacing:0.08em; margin-left:8px;">HOURLY FORECAST</div>
  <div id="hourly-chart" style="width:100%; height:{{ chart_height | default: 260 }}px; image-rendering: pixelated;"></div>
</div>
<script>
var iconClasses = [{{ icon_classes }}];
var hourTimes = [{{ hour_times }}];
var sunEvents = [
  {% for entry in daily.entries %}{% if forloop.first == false %},{% endif %}{ rise: "{{ entry.sunrise }}", set: "{{ entry.sunset }}" }{% endfor %}
];
function sunPlotLines() {
  var lines = [];
  var startTime = hourTimes[0];
  var endTime = hourTimes[hourTimes.length - 1];
  for (var i = 0; i < sunEvents.length; i++) {
    var ev = sunEvents[i];
    var events = [{ t: ev.rise, label: 'sunrise', icon: 'wi-sunrise' }, { t: ev.set, label: 'sunset', icon: 'wi-sunset' }];
    for (var j = 0; j < events.length; j++) {
      var t = events[j].t;
      if (t >= startTime && t <= endTime) {
        var tHour = t.slice(0, 13);
        for (var k = 0; k < hourTimes.length; k++) {
          if (hourTimes[k].slice(0, 13) === tHour) {
            var mins = parseInt(t.slice(14, 16), 10);
            var h = parseInt(t.slice(11, 13), 10);
            var ampm = h < 12 ? 'am' : 'pm';
            var h12 = h === 0 ? 12 : (h > 12 ? h - 12 : h);
            var timeStr2 = h12 + ':' + (mins < 10 ? '0' : '') + mins + ampm;
            lines.push({ value: k + mins / 60, label: timeStr2, icon: events[j].icon });
            break;
          }
        }
      }
    }
  }
  return lines;
}
function sunPlotBands() {
  var bands = [];
  var startTime = hourTimes[0];
  var endTime = hourTimes[hourTimes.length - 1];
  var maxX = hourTimes.length - 0.5;
  // Collect all sunrise/sunset times within or near the chart range
  var rises = [];
  var sets = [];
  for (var i = 0; i < sunEvents.length; i++) {
    var ev = sunEvents[i];
    if (ev.rise >= startTime && ev.rise <= endTime) rises.push(ev.rise);
    if (ev.set >= startTime && ev.set <= endTime) sets.push(ev.set);
  }
  // Helper: convert an ISO time string to an x-axis position
  function timeToX(t) {
    var tHour = t.slice(0, 13);
    for (var k = 0; k < hourTimes.length; k++) {
      if (hourTimes[k].slice(0, 13) === tHour) {
        var mins = parseInt(t.slice(14, 16), 10);
        return k + mins / 60;
      }
    }
    return null;
  }
  // Build a sorted list of sun transitions within the chart
  var transitions = [];
  for (var i = 0; i < rises.length; i++) transitions.push({ t: rises[i], type: 'rise' });
  for (var i = 0; i < sets.length; i++) transitions.push({ t: sets[i], type: 'set' });
  transitions.sort(function(a, b) { return a.t < b.t ? -1 : a.t > b.t ? 1 : 0; });
  if (transitions.length === 0) {
    // No sun events in range — check if chart is entirely nighttime
    // If the first hourly entry is before any sunrise, it's night
    for (var i = 0; i < sunEvents.length; i++) {
      if (sunEvents[i].rise > startTime) {
        bands.push({ from: -0.5, to: maxX });
        break;
      }
      if (sunEvents[i].set > startTime) break;
    }
    return bands;
  }
  // If the first transition is sunrise, there's night before it
  var pos = 0;
  if (transitions[0].type === 'rise') {
    var x = timeToX(transitions[0].t);
    if (x !== null && x > 0) bands.push({ from: -0.5, to: x });
    pos = 1;
  }
  // Pair sunsets with following sunrises
  for (var i = pos; i < transitions.length; i++) {
    if (transitions[i].type === 'set') {
      var fromX = timeToX(transitions[i].t);
      var toX = maxX;
      // Look for the next sunrise
      if (i + 1 < transitions.length && transitions[i + 1].type === 'rise') {
        toX = timeToX(transitions[i + 1].t);
        i++; // skip the paired sunrise
      }
      if (fromX !== null && toX !== null) bands.push({ from: fromX, to: toX });
    }
  }
  return bands;
}
var chart = Highcharts.chart('hourly-chart', {
  chart: {
    animation: false,
    backgroundColor: 'transparent',
    margin: [22, 8, 44, 8],
    spacing: [0, 0, 0, 0],
    style: { fontFamily: 'Inter, sans-serif' }
  },
  title: { text: null },
  legend: { enabled: false },
  tooltip: { enabled: false },
  credits: { enabled: false },
  plotOptions: {
    series: { enableMouseTracking: false, animation: false },
    column: { groupPadding: 0, pointPadding: 0, borderWidth: 0 }
  },
  xAxis: {
    categories: [{{ hour_labels }}],
    tickInterval: 4,
    labels: {
      style: { fontSize: '20px', color: '#000', fontFamily: 'Inter, sans-serif' },
      rotation: 0,
      align: 'center',
      y: 16,
      formatter: function() { return this.value; }
    },
    gridLineDashStyle: 'dot',
    lineColor: '#000',
    tickColor: '#000',
    plotLines: sunPlotLines().map(function(pl) {
      var nearEdge = pl.value < 1.5 || pl.value > hourTimes.length - 2.5;
      return {
        value: pl.value,
        color: 'rgba(0, 0, 0, 0.3)',
        width: 1,
        dashStyle: 'shortdot',
        label: {
          text: nearEdge ? '' : '<i class="wi ' + pl.icon + '" style="font-size:16px;"></i> ' + pl.label,
          useHTML: true,
          align: 'left',
          x: -10,
          rotation: 0,
          style: { fontSize: '16px', color: '#000', fontFamily: 'Inter, sans-serif' },
          y: -5
        }
      };
    }),
    plotBands: sunPlotBands().map(function(band) {
      return { from: band.from, to: band.to, color: { pattern: { image: 'https://trmnl.com/images/grayscale/gray-7.png', width: 12, height: 12 } } };
    })
  },
  yAxis: [
    {
      title: { text: null },
      tickAmount: 5,
      maxPadding: 0.3,
      labels: { enabled: false },
      gridLineDashStyle: 'shortdot',
      gridLineColor: '#000'
    },
    {
      title: { text: null },
      min: 0, max: 100,
      opposite: true,
      labels: { enabled: false },
      gridLineWidth: 0
    },
    {
      title: { text: null },
      linkedTo: 0,
      opposite: true,
      tickAmount: 5,
      labels: { enabled: false },
      gridLineWidth: 0
    }
  ],
  series: [
    {
      name: 'Precip %',
      type: 'column',
      data: [{{ precip_data }}],
      yAxis: 1,
      color: { pattern: { image: 'https://trmnl.com/images/grayscale/gray-5.png', width: 12, height: 12 } },
      zIndex: 0
    },
    {
      name: 'Temp',
      type: 'spline',
      data: [{{ temp_data }}],
      yAxis: 0,
      color: '#000',
      lineWidth: 4,
      marker: { enabled: false },
      zIndex: 1,
      dataLabels: {
        enabled: true,
        useHTML: true,
        formatter: function() {
          if (this.point.index % 4 !== 0) return null;
          var cls = iconClasses[this.point.index];
          return '<div style="text-align:center;line-height:1.3;"><i class="wi ' + cls + ' text-stroke text-stroke--medium" style="font-size:20px;"></i><br><span class="text-stroke text-stroke--medium" style="font-size:16px;font-weight:700;">' + Math.round(this.y) + '&deg;</span></div>';
        },
        y: -2,
        padding: 0,
        backgroundColor: 'none',
        borderWidth: 0,
        shadow: false,
        style: { color: '#000' }
      }
    }
  ]
});
</script>
{% endtemplate %}

{% comment %}
  weather_daily_bars_vertical: Vertical forecast bars for right column
  Params: daily_entries, num_days, padding_top (default 20)
{% endcomment %}
{% template weather_daily_bars_vertical %}
{% assign overall_min = daily_entries[0].low %}
{% assign overall_max = daily_entries[0].high %}
{% for entry in daily_entries %}
  {% if entry.low < overall_min %}{% assign overall_min = entry.low %}{% endif %}
  {% if entry.high > overall_max %}{% assign overall_max = entry.high %}{% endif %}
{% endfor %}
{% assign overall_min_int = overall_min | floor %}
{% assign overall_max_int = overall_max | ceil %}
{% assign range = overall_max_int | minus: overall_min_int %}
{% if range < 1 %}{% assign range = 1 %}{% endif %}

<div style="display:flex; flex-direction:column; height:100%; padding-top:{{ padding_top | default: 20 }}px;">
  {% assign day_limit = num_days | default: 6 %}
  {% if day_limit > 1 %}<div class="label" data-pixel-perfect="true" style="letter-spacing:0.08em; margin-bottom:8px;">DAILY FORECAST</div>{% endif %}
  <div style="display:flex; flex-direction:column; flex:1; justify-content:space-evenly;">
{% if current_temp %}
  {% assign current_temp_int = current_temp | round %}
  {% assign current_marker_pct = current_temp_int | minus: overall_min_int | times: 100 | divided_by: range | at_least: 0 | at_most: 100 %}
{% endif %}
  {% for entry in daily_entries limit: day_limit %}
    {% assign left_pct = entry.low | minus: overall_min_int | times: 100 | divided_by: range | at_least: 0 %}
    {% assign width_pct = entry.high | minus: entry.low | times: 100 | divided_by: range | at_least: 1 %}
    <div style="margin:2px 0;">
      {% if forloop.first and current_temp %}
      <div style="display:flex; align-items:flex-end; padding-left:116px; padding-right:38px; margin-bottom:0;">
        <div style="flex:1; position:relative; height:2px; min-width:0;">
          <span style="position:absolute; left:{{ current_marker_pct }}%; transform:translateX(-50%); font-size:10px; line-height:1;">&#9660;</span>
        </div>
      </div>
      {% endif %}
      <div style="display:flex; align-items:center; gap:2px;">
        <div style="width:68px; flex-shrink:0;">
          <div class="description" data-pixel-perfect="true" style="line-height:1.2;">{% if forloop.first %}Today{% else %}{{ entry.date | date: "%A" }}{% endif %}</div>
          <div style="display:flex; align-items:center; gap:3px;">
            <i class="wi wi-raindrop" style="font-size:10px;"></i>
            <span class="description" data-pixel-perfect="true">{{ entry.precipitation_probability }}%</span>
          </div>
        </div>
        <div style="width:36px; flex-shrink:0; display:flex; justify-content:center;"><i class="wi {{ entry.icon_class }}" style="font-size:22px;"></i></div>
        <div style="width:34px; flex-shrink:0; display:flex; justify-content:flex-end; margin-right:4px;"><span class="value--xsmall" data-pixel-perfect="true" style="white-space:nowrap;">{{ entry.low }}&deg;</span></div>
        <div style="flex:1; height:20px; background:url('https://trmnl.com/images/grayscale/gray-7.png') repeat; image-rendering:pixelated; border:1px solid #000; border-radius:10px; min-width:0; position:relative;">
          <div style="position:absolute; left:{{ left_pct }}%; width:{{ width_pct }}%; height:100%; background:url('https://trmnl.com/images/grayscale/gray-3.png') repeat; image-rendering:pixelated; border-radius:10px;"></div>
        </div>
        <div style="width:34px; flex-shrink:0; display:flex; justify-content:flex-start; margin-left:4px;"><span class="value--xsmall" data-pixel-perfect="true" style="white-space:nowrap;">{{ entry.high }}&deg;</span></div>
      </div>
    </div>
  {% endfor %}
  </div>
</div>
{% endtemplate %}

{% comment %}
  title_bar: Standard bottom bar
  Params: plugin_name
{% endcomment %}
{% template title_bar %}
<div class="title_bar">
  {% if icon_class %}<i class="wi {{ icon_class }} text-stroke text-stroke--thick" style="font-size:20px; margin-right:6px;"></i>{% endif %}
  <span class="title">{{ plugin_name }}</span>
  {% if updated_at %}
  <span class="instance" style="margin-left:auto;">Updated {{ updated_at | date: "%a %-I:%M %p" }}</span>
  {% endif %}
</div>
{% endtemplate %}
