<style>
@font-face {
  font-family: 'weathericons';
  src: url('https://cdn.jsdelivr.net/gh/erikflowers/weather-icons@2.0.10/font/weathericons-regular-webfont.woff2') format('woff2');
  font-weight: normal;
  font-style: normal;
}
.wi {
  font-family: 'weathericons';
  font-style: normal;
  font-weight: normal;
  font-variant: normal;
  text-transform: none;
  line-height: 1;
  -webkit-font-smoothing: antialiased;
}
.wi::before { display: inline-block; }
.wi-day-sunny:before { content: "\f00d"; }
.wi-day-sunny-overcast:before { content: "\f00c"; }
.wi-day-cloudy:before { content: "\f002"; }
.wi-night-clear:before { content: "\f02e"; }
.wi-night-partly-cloudy:before { content: "\f083"; }
.wi-night-cloudy:before { content: "\f031"; }
.wi-wmo4680-3:before { content: "\f013"; }
.wi-wmo4680-45:before { content: "\f015"; }
.wi-wmo4680-48:before { content: "\f01b"; }
.wi-wmo4680-51:before { content: "\f01c"; }
.wi-wmo4680-52:before { content: "\f019"; }
.wi-wmo4680-53:before { content: "\f019"; }
.wi-wmo4680-54:before { content: "\f076"; }
.wi-wmo4680-55:before { content: "\f076"; }
.wi-wmo4680-56:before { content: "\f076"; }
.wi-wmo4680-57:before { content: "\f01c"; }
.wi-wmo4680-61:before { content: "\f01c"; }
.wi-wmo4680-62:before { content: "\f019"; }
.wi-wmo4680-63:before { content: "\f019"; }
.wi-wmo4680-64:before { content: "\f015"; }
.wi-wmo4680-65:before { content: "\f015"; }
.wi-wmo4680-66:before { content: "\f015"; }
.wi-wmo4680-67:before { content: "\f017"; }
.wi-wmo4680-71:before { content: "\f01b"; }
.wi-wmo4680-72:before { content: "\f01b"; }
.wi-wmo4680-73:before { content: "\f01b"; }
.wi-wmo4680-74:before { content: "\f076"; }
.wi-wmo4680-75:before { content: "\f076"; }
.wi-wmo4680-76:before { content: "\f076"; }
.wi-wmo4680-77:before { content: "\f01b"; }
.wi-wmo4680-80:before { content: "\f019"; }
.wi-wmo4680-81:before { content: "\f01c"; }
.wi-wmo4680-82:before { content: "\f019"; }
.wi-wmo4680-85:before { content: "\f017"; }
.wi-wmo4680-86:before { content: "\f017"; }
.wi-wmo4680-95:before { content: "\f01e"; }
.wi-wmo4680-96:before { content: "\f01e"; }
.wi-wmo4680-99:before { content: "\f056"; }
.wi-na:before { content: "\f07b"; }
.wi-raindrop:before { content: "\f078"; }
.wi-sunrise:before { content: "\f051"; }
.wi-sunset:before { content: "\f052"; }
</style>

{% comment %}
  weather_current: Current conditions block
  Params: current, location_name
{% endcomment %}
{% template weather_current %}
<div style="display:flex; flex-direction:row; justify-content:space-between; align-items:center; width:100%; padding: 4px 0;">
  <div>
    <div class="label label--medium" data-pixel-perfect="true" style="letter-spacing:0.05em;">{{ location_name | upcase }}</div>
    <div class="description" data-pixel-perfect="true" style="margin-top:4px;">{{ current.condition }}</div>
    <div class="description" data-pixel-perfect="true">Feels like {{ current.apparent_temperature_f }}°F</div>
    <div class="description" data-pixel-perfect="true">Humidity {{ current.relative_humidity }}%</div>
    <div class="description" data-pixel-perfect="true">Wind {{ current.wind_speed_mph }} mph {{ current.wind_direction }}</div>
  </div>
  <div class="value" data-pixel-perfect="true" style="font-size:64px; line-height:1;">{{ current.temperature_f }}°F</div>
</div>
{% endtemplate %}

{% comment %}
  weather_current_compact: Compact current conditions for two-column layout
  Params: current
{% endcomment %}
{% template weather_current_compact %}
<div style="display:flex; flex-direction:row; align-items:center; justify-content:center; width:100%; padding:8px 0; gap:16px;">
  <div class="value" data-pixel-perfect="true" style="font-size:48px; line-height:1; white-space:nowrap; width:fit-content;">{{ current.temperature_f }}°F / {{ current.temperature_c }}°C</div>
  <i class="wi {{ current.icon_class }}" style="font-size:60px; line-height:1;"></i>
  <div style="text-align:left; min-width:0;">
    <div class="description" data-pixel-perfect="true" style="font-size:18px; font-weight:600; white-space:nowrap;">{{ current.condition }}</div>
    <div class="description" data-pixel-perfect="true" style="font-size:18px; white-space:nowrap;">Feels like {{ current.apparent_temperature_f }}°F</div>
    <div class="description" data-pixel-perfect="true" style="font-size:18px; white-space:nowrap;">Humidity {{ current.relative_humidity }}%</div>
    <div class="description" data-pixel-perfect="true" style="font-size:18px; white-space:nowrap;">Wind {{ current.wind_speed_mph }} mph {{ current.wind_direction }}</div>
  </div>
</div>
{% endtemplate %}

{% comment %}
  weather_hourly_chart: Highcharts spline for next 24 hours
  Params: hourly, daily, current_time, chart_height
{% endcomment %}
{% template weather_hourly_chart %}
<script src="https://trmnl.com/js/highcharts/12.3.0/highcharts.js"></script>
{% assign hour_labels = "" %}
{% assign temp_data = "" %}
{% assign precip_data = "" %}
{% assign icon_classes = "" %}
{% assign hour_times = "" %}
{% for entry in hourly.entries %}
  {% if forloop.first %}
    {% assign hour_labels = entry.label | prepend: '"' | append: '"' %}
    {% assign temp_data = entry.temperature_f | append: "" %}
    {% assign precip_data = entry.precipitation_probability | append: "" %}
    {% assign icon_classes = entry.icon_class | prepend: '"' | append: '"' %}
    {% assign hour_times = entry.time | prepend: '"' | append: '"' %}
  {% else %}
    {% assign hour_labels = hour_labels | append: ',"' | append: entry.label | append: '"' %}
    {% assign temp_data = temp_data | append: "," | append: entry.temperature_f %}
    {% assign precip_data = precip_data | append: "," | append: entry.precipitation_probability %}
    {% assign icon_classes = icon_classes | append: ',"' | append: entry.icon_class | append: '"' %}
    {% assign hour_times = hour_times | append: ',"' | append: entry.time | append: '"' %}
  {% endif %}
{% endfor %}
<div style="margin: 4px 0;">
  <div class="label" data-pixel-perfect="true" style="font-size:11px; letter-spacing:0.08em; margin-left:58px;">NEXT 24 HOURS</div>
  <div id="hourly-chart" style="width:100%; height:{{ chart_height | default: 260 }}px; image-rendering: pixelated;"></div>
</div>
<script>
var iconClasses = [{{ icon_classes }}];
var hourTimes = [{{ hour_times }}];
var sunEvents = [
  {% for entry in daily.entries %}{% if forloop.first == false %},{% endif %}{ rise: "{{ entry.sunrise }}", set: "{{ entry.sunset }}" }{% endfor %}
];
function sunPlotLines() {
  var lines = [];
  var startTime = hourTimes[0];
  var endTime = hourTimes[hourTimes.length - 1];
  for (var i = 0; i < sunEvents.length; i++) {
    var ev = sunEvents[i];
    var events = [{ t: ev.rise, label: 'sunrise', icon: 'wi-sunrise' }, { t: ev.set, label: 'sunset', icon: 'wi-sunset' }];
    for (var j = 0; j < events.length; j++) {
      var t = events[j].t;
      if (t >= startTime && t <= endTime) {
        var tHour = t.slice(0, 13);
        for (var k = 0; k < hourTimes.length; k++) {
          if (hourTimes[k].slice(0, 13) === tHour) {
            var mins = parseInt(t.slice(14, 16), 10);
            var h = parseInt(t.slice(11, 13), 10);
            var ampm = h < 12 ? 'am' : 'pm';
            var h12 = h === 0 ? 12 : (h > 12 ? h - 12 : h);
            var timeStr2 = h12 + ':' + (mins < 10 ? '0' : '') + mins + ampm;
            lines.push({ value: k + mins / 60, label: timeStr2, icon: events[j].icon });
            break;
          }
        }
      }
    }
  }
  return lines;
}
var chart = Highcharts.chart('hourly-chart', {
  chart: {
    animation: false,
    backgroundColor: 'transparent',
    margin: [22, 58, 68, 58],
    spacing: [0, 0, 0, 0],
    style: { fontFamily: 'Inter, sans-serif' }
  },
  title: { text: null },
  legend: { enabled: false },
  tooltip: { enabled: false },
  credits: { enabled: false },
  plotOptions: {
    series: { enableMouseTracking: false, animation: false },
    column: { groupPadding: 0, pointPadding: 0, borderWidth: 0 }
  },
  xAxis: {
    categories: [{{ hour_labels }}],
    tickInterval: 4,
    labels: {
      useHTML: true,
      style: { fontSize: '16px', color: '#000', fontFamily: 'Inter, sans-serif' },
      rotation: 0,
      align: 'center',
      formatter: function() {
        var cls = iconClasses[this.pos];
        return '<div style="text-align:center;line-height:1.2;"><i class="wi ' + cls + '" style="font-size:22px;"></i><br>' + this.value + '</div>';
      }
    },
    gridLineDashStyle: 'dot',
    lineColor: '#000',
    tickColor: '#000',
    plotLines: sunPlotLines().map(function(pl) {
      var nearEdge = pl.value < 1.5 || pl.value > hourTimes.length - 2.5;
      return {
        value: pl.value,
        color: '#000',
        width: 2,
        dashStyle: 'dash',
        label: {
          text: nearEdge ? '' : '<i class="wi ' + pl.icon + '" style="font-size:14px;"></i> ' + pl.label,
          useHTML: true,
          align: 'center',
          x: 0,
          rotation: 0,
          style: { fontSize: '12px', color: '#000', fontFamily: 'Inter, sans-serif' },
          y: -2
        }
      };
    })
  },
  yAxis: [
    {
      title: { text: null },
      tickAmount: 5,
      labels: { style: { fontSize: '16px', color: '#000', fontFamily: 'Inter, sans-serif' }, formatter: function() { return Math.round(this.value) + '°F'; } },
      gridLineDashStyle: 'shortdot',
      gridLineColor: '#000'
    },
    {
      title: { text: null },
      min: 0, max: 100,
      opposite: true,
      labels: { enabled: false },
      gridLineWidth: 0
    },
    {
      title: { text: null },
      linkedTo: 0,
      opposite: true,
      tickAmount: 5,
      labels: { style: { fontSize: '16px', color: '#000', fontFamily: 'Inter, sans-serif' }, formatter: function() { return Math.round((this.value - 32) * 5 / 9) + '°C'; } },
      gridLineWidth: 0
    }
  ],
  series: [
    {
      name: 'Precip %',
      type: 'column',
      data: [{{ precip_data }}],
      yAxis: 1,
      color: 'url(#precip-stripe)',
      zIndex: 0
    },
    {
      name: 'Temp',
      type: 'spline',
      data: [{{ temp_data }}],
      yAxis: 0,
      color: '#000',
      lineWidth: 4,
      marker: { enabled: false },
      zIndex: 1
    }
  ]
});
var svgNS = 'http://www.w3.org/2000/svg';
var defs = document.createElementNS(svgNS, 'defs');
var pattern = document.createElementNS(svgNS, 'pattern');
pattern.setAttribute('id', 'precip-stripe');
pattern.setAttribute('patternUnits', 'userSpaceOnUse');
pattern.setAttribute('width', '8');
pattern.setAttribute('height', '8');
var img = document.createElementNS(svgNS, 'image');
img.setAttribute('href', 'https://trmnl.com/images/grayscale/gray-5.png');
img.setAttribute('width', '8');
img.setAttribute('height', '8');
pattern.appendChild(img);
defs.appendChild(pattern);
chart.renderer.box.appendChild(defs);
chart.series[0].update({ color: 'url(#precip-stripe)' }, true);
</script>
{% endtemplate %}

{% comment %}
  weather_daily_bars: N-day forecast with CSS range bars
  Params: daily, num_days
{% endcomment %}
{% template weather_daily_bars %}
{% assign overall_min = daily.entries[1].low_f %}
{% assign overall_max = daily.entries[1].high_f %}
{% for entry in daily.entries offset: 1 %}
  {% if entry.low_f < overall_min %}{% assign overall_min = entry.low_f %}{% endif %}
  {% if entry.high_f > overall_max %}{% assign overall_max = entry.high_f %}{% endif %}
{% endfor %}
{% assign overall_min_int = overall_min | floor %}
{% assign overall_max_int = overall_max | ceil %}
{% assign range = overall_max_int | minus: overall_min_int %}
{% if range < 1 %}{% assign range = 1 %}{% endif %}

<div style="margin: 4px 0;">
  <div class="label" data-pixel-perfect="true" style="font-size:11px; letter-spacing:0.08em;">{{ section_label | default: "NEXT 4 DAYS" }}</div>
  {% for entry in daily.entries offset: 1 %}
    {% assign left_pct = entry.low_f | minus: overall_min_int | times: 100 | divided_by: range | at_least: 0 %}
    {% assign width_pct = entry.high_f | minus: entry.low_f | times: 100 | divided_by: range | at_least: 1 %}
    <div class="flex flex--row flex--middle" style="width:100%; margin: 2px 0; gap: 8px;">
      <div class="description" data-pixel-perfect="true" style="width:32px; font-size:12px; font-weight:600;">{{ entry.date | date: "%a" }}</div>
      <div class="description" data-pixel-perfect="true" style="width:28px; font-size:11px; text-align:right;">{{ entry.precipitation_probability }}%</div>
      <div class="description" data-pixel-perfect="true" style="width:40px; font-size:11px; text-align:right; flex-shrink:0;">{{ entry.low_f }}°F</div>
      <div style="flex:1; position:relative; height:8px; background:url('https://trmnl.com/images/grayscale/gray-7.png') repeat; image-rendering:pixelated; border:1px solid #000; border-radius:8px; min-width:40px;">
        <div style="position:absolute; left:{{ left_pct }}%; width:{{ width_pct }}%; height:100%; background:url('https://trmnl.com/images/grayscale/gray-4.png') repeat; image-rendering:pixelated; border-radius:8px;"></div>
      </div>
      <div class="description" data-pixel-perfect="true" style="width:40px; font-size:11px; flex-shrink:0;">{{ entry.high_f }}°F</div>
    </div>
  {% endfor %}
</div>
{% endtemplate %}

{% comment %}
  weather_daily_bars_vertical: Vertical forecast bars for right column
  Params: daily_entries, num_days
{% endcomment %}
{% template weather_daily_bars_vertical %}
{% assign overall_min = daily_entries[0].low_f %}
{% assign overall_max = daily_entries[0].high_f %}
{% for entry in daily_entries %}
  {% if entry.low_f < overall_min %}{% assign overall_min = entry.low_f %}{% endif %}
  {% if entry.high_f > overall_max %}{% assign overall_max = entry.high_f %}{% endif %}
{% endfor %}
{% assign overall_min_int = overall_min | floor %}
{% assign overall_max_int = overall_max | ceil %}
{% assign range = overall_max_int | minus: overall_min_int %}
{% if range < 1 %}{% assign range = 1 %}{% endif %}

<div style="display:flex; flex-direction:column; height:100%;">
  <div class="label" data-pixel-perfect="true" style="font-size:11px; letter-spacing:0.08em;">NEXT 4 DAYS</div>
  <div style="display:flex; flex-direction:column; flex:1; justify-content:space-between;">
  {% assign day_limit = num_days | default: 6 %}
  {% for entry in daily_entries limit: day_limit %}
    {% assign left_pct = entry.low_f | minus: overall_min_int | times: 100 | divided_by: range | at_least: 0 %}
    {% assign width_pct = entry.high_f | minus: entry.low_f | times: 100 | divided_by: range | at_least: 1 %}
    <div style="margin:6px 0;">
      <div style="display:flex; justify-content:space-between; margin-bottom:2px;">
        <span class="description" data-pixel-perfect="true" style="font-size:12px; font-weight:700;">{{ entry.date | date: "%a" }}</span>
        <span style="display:flex; align-items:center; gap:2px;"><i class="wi wi-raindrop" style="font-size:10px;"></i><span class="description" data-pixel-perfect="true" style="font-size:11px; font-weight:700;">{{ entry.precipitation_probability }}%</span></span>
      </div>
      <div style="display:flex; align-items:center; gap:4px;">
        <i class="wi {{ entry.icon_class }}" style="font-size:24px; width:28px; text-align:center; flex-shrink:0;"></i>
        <div style="position:relative; flex:1; height:26px; background:url('https://trmnl.com/images/grayscale/gray-7.png') repeat; image-rendering:pixelated; border:1px solid #000; border-radius:8px; min-width:0;">
          <div style="position:absolute; left:{{ left_pct }}%; width:{{ width_pct }}%; height:100%; background:url('https://trmnl.com/images/grayscale/gray-4.png') repeat; image-rendering:pixelated; border-radius:8px;"></div>
        {% if width_pct >= 25 %}
        <span class="description description--large text-stroke text-stroke--medium text-stroke--black" data-pixel-perfect="true" style="position:absolute; left:{{ left_pct | plus: 4 }}%; top:50%; transform:translateY(-50%); color:#fff; font-size:13px; font-weight:700; white-space:nowrap; z-index:1;">{{ entry.low_f }}°</span>
        <span class="description description--large text-stroke text-stroke--medium text-stroke--black" data-pixel-perfect="true" style="position:absolute; left:{{ left_pct | plus: width_pct | minus: 4 }}%; top:50%; transform:translate(-100%,-50%); color:#fff; font-size:13px; font-weight:700; white-space:nowrap; z-index:1;">{{ entry.high_f }}°</span>
        {% else %}
        <span class="description description--large text-stroke text-stroke--medium text-stroke--white" data-pixel-perfect="true" style="position:absolute; left:{{ left_pct | minus: 1 }}%; top:50%; transform:translate(-100%,-50%); color:#000; font-size:13px; font-weight:700; white-space:nowrap;">{{ entry.low_f }}°</span>
        {% if entry.high_f != entry.low_f %}
        <span class="description description--large text-stroke text-stroke--medium text-stroke--white" data-pixel-perfect="true" style="position:absolute; left:{{ left_pct | plus: width_pct | plus: 1 }}%; top:50%; transform:translateY(-50%); color:#000; font-size:13px; font-weight:700; white-space:nowrap;">{{ entry.high_f }}°</span>
        {% endif %}
        {% endif %}
        </div>
      </div>
    </div>
  {% endfor %}
  </div>
</div>
{% endtemplate %}

{% comment %}
  title_bar: Standard bottom bar
  Params: plugin_name
{% endcomment %}
{% template title_bar %}
<div class="title_bar">
  <span class="title">{{ plugin_name }}</span>
  {% if updated_at %}
  <span class="instance" style="margin-left:auto;">Updated {{ updated_at | date: "%a %-I:%M %p" }}</span>
  {% endif %}
</div>
{% endtemplate %}
